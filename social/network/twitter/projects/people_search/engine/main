#!/usr/bin/env jruby

require 'rubygems'
require 'swineherd' ; include Swineherd
require 'swineherd/script/pig_script' ; include Swineherd::Script
require 'json'

inputdir  = ARGV[0]
outputdir = ARGV[1]

#
# Get new hadoop file system
#
hdfs = Swineherd::FileSystem.get(:hdfs)

#
# Read in working config file
#
options = YAML.load(hdfs.open(File.join(outputdir, "env", "working_environment.yaml")).read)

#
# Define workflow
#
flow = Swineherd::Workflow.new(options['flow_id']) do
  profile_dumper  = PigScript.new(File.dirname(__FILE__)+'/templates/profile_dumper.pig.erb')
  profile_indexer = PigScript.new(File.dirname(__FILE__)+'/templates/profile_loader.pig.erb')

  task :dump_profiles do
    profile_dumper.env['PIG_CLASSPATH'] = options['pig_classpath']
    profile_dumper.env['PIG_OPTS']      = options['pig_options']
    profile_dumper.attributes = {
      :jars                 => options['hbase_jars'],
      :hbase_table          => options['hbase_table'],
      :hbase_column_family  => options['hbase_column_family'],
      :reduce_tasks         => options['hadoop_reduce_tasks'],
      :twitter_user_profile => options['twitter_user_profile'],
      :hdfs                 => "hdfs://#{options['hdfs']}",
      :out                  => next_output(:dump_profiles)
    }
    profile_dumper.run unless hdfs.exists? latest_output(:dump_profiles)
  end

  task :index_profiles => [:dump_profiles] do
    profile_indexer.env['PIG_CLASSPATH'] = options['pig_classpath']
    profile_indexer.env['PIG_OPTS']      = options['pig_options']
    profile_indexer.attributes = {
      :jars                 => options['es_jars'],
      :data                 => latest_output(:dump_profiles),
      :twitter_user_profile => options['twitter_user_profile'],
      :es_index             => options['es_index'],
      :es_obj_type          => options['es_obj_type'],
      :bulk_size            => 500
    }
    fake_hdfs_output = next_output(:index_profiles)
    profile_indexer.run unless hdfs.exists? fake_hdfs_output
    hdfs.mkpath fake_hdfs_output
  end


end

flow.workdir = File.join(inputdir, "rawd")
flow.describe

#
# Run workflow
#
flow.run :index_profiles
